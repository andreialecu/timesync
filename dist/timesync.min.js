!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.timesync=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=emitter;function emitter(obj){var _callbacks={};obj.emit=function(event,data){var callbacks=_callbacks[event];callbacks&&callbacks.forEach(function(callback){return callback(data)})};obj.on=function(event,callback){var callbacks=_callbacks[event]||(_callbacks[event]=[]);callbacks.push(callback);return obj};obj.off=function(event,callback){if(callback){var callbacks=_callbacks[event];var index=callbacks.indexOf(callback);if(index!==-1){callbacks.splice(index,1)}if(callbacks.length===0){delete _callbacks[event]}}else{delete _callbacks[event]}return obj};obj.list=function(event){return _callbacks[event]||[]};return obj}},{}],2:[function(require,module,exports){"use strict";exports.compare=compare;exports.add=add;exports.sum=sum;exports.mean=mean;exports.std=std;exports.variance=variance;exports.median=median;Object.defineProperty(exports,"__esModule",{value:true});function compare(a,b){return a>b?1:a<b?-1:0}function add(a,b){return a+b}function sum(arr){return arr.reduce(add)}function mean(arr){return sum(arr)/arr.length}function std(arr){return Math.sqrt(variance(arr))}function variance(arr){if(arr.length<2){return 0}var _mean=mean(arr);return arr.map(function(x){return Math.pow(x-_mean,2)}).reduce(add)/(arr.length-1)}function median(arr){if(arr.length<2){return arr[0]}var sorted=arr.slice().sort(compare);if(sorted.length%2===0){return(sorted[arr.length/2-1]+sorted[arr.length/2])/2}else{return sorted[(arr.length-1)/2]}}},{}],3:[function(require,module,exports){"use strict";var _interopRequire=function(obj){return obj&&obj.__esModule?obj["default"]:obj};var _interopRequireWildcard=function(obj){return obj&&obj.__esModule?obj:{"default":obj}};exports.create=create;Object.defineProperty(exports,"__esModule",{value:true});var util=_interopRequireWildcard(require("./util.js"));var stat=_interopRequireWildcard(require("./stat.js"));var emitter=_interopRequire(require("./emitter.js"));function create(options){var timesync={options:{interval:60*60*1e3,timeout:1e4,delay:1e3,repeat:5,peers:[],server:null,now:Date.now},offset:0,_timeout:null,_inProgress:{},_isFirst:true,send:function send(to,data){try{fetch(to,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(data)}).then(function(res){return res.json()}).then(function(res){return timesync.receive(to,res)})["catch"](function(err){return emitError(err)})}catch(err){emitError(err)}},receive:function receive(from,data){if(data===undefined){data=from;from=undefined}if(data&&data.id in timesync._inProgress){timesync._inProgress[data.id](data.result)}else if(data&&data.id!==undefined){timesync.send(from,{jsonrpc:"2.0",id:data.id,result:timesync.now()})}},rpc:function rpc(to,method,params){return new Promise(function(resolve,reject){var id=util.nextId();var timeout=setTimeout(function(){delete timesync._inProgress[id];reject(new Error("Timeout"))},timesync.options.timeout);timesync._inProgress[id]=function(data){clearTimeout(timeout);delete timesync._inProgress[id];resolve(data)};timesync.send(to,{jsonrpc:"2.0",id:id,method:method,params:params})})},sync:function sync(){timesync.emit("sync","start");var peers=timesync.options.server?[timesync.options.server]:timesync.options.peers;return Promise.all(peers.map(function(peer){return timesync._syncWithPeer(peer)})).then(function(all){var offsets=all.filter(function(offset){return timesync._validOffset(offset)});if(offsets.length>0){timesync.offset=stat.mean(offsets);timesync.emit("change",timesync.offset)}timesync.emit("sync","end")})},_validOffset:function _validOffset(offset){return offset!==null&&!isNaN(offset)&&isFinite(offset)},_syncWithPeer:function _syncWithPeer(peer){var all=[];function sync(){return timesync._getOffset(peer).then(function(result){return all.push(result)})}function waitAndSync(){return util.wait(timesync.options.delay).then(sync)}function notDone(){return all.length<timesync.options.repeat}return sync().then(function(){return util.whilst(notDone,waitAndSync)}).then(function(){var results=all.filter(function(result){return result!==null});var roundtrips=results.map(function(result){return result.roundtrip});var limit=stat.median(roundtrips)+stat.std(roundtrips);var filtered=results.filter(function(result){return result.roundtrip<limit});var offsets=filtered.map(function(result){return result.offset});return offsets.length>0?stat.mean(offsets):null})},_getOffset:function _getOffset(peer){var start=Date.now();return timesync.rpc(peer,"timesync").then(function(timestamp){var end=Date.now();var roundtrip=end-start;var offset=timestamp-end+roundtrip/2;if(timesync._isFirst){timesync._isFirst=false;timesync.offset=offset;timesync.emit("change",offset)}return{roundtrip:roundtrip,offset:offset}})["catch"](function(err){return null})},now:function now(){return timesync.options.now()+timesync.offset},destroy:function destroy(){clearTimeout(timesync._timeout)}};if(options){if(options.server&&options.peers){throw new Error('Configure either option "peers" or "server", not both.')}for(var prop in options){if(options.hasOwnProperty(prop)){if(prop==="peers"&&typeof options.peers==="string"){timesync.options.peers=options.peers.split(",").map(function(peer){return peer.trim()}).filter(function(peer){return peer!==""})}else{timesync.options[prop]=options[prop]}}}}emitter(timesync);function emitError(err){if(timesync.list("error").length>0){timesync.emit("error",err)}else{console.log("Error",err)}}if(timesync.options.interval!==null){timesync._timeout=setInterval(timesync.sync,timesync.options.interval);setTimeout(function(){timesync.sync()["catch"](function(err){return emitError(err)})},0)}return timesync}},{"./emitter.js":1,"./stat.js":2,"./util.js":4}],4:[function(require,module,exports){"use strict";exports.wait=wait;exports.repeat=repeat;exports.whilst=whilst;exports.nextId=nextId;Object.defineProperty(exports,"__esModule",{value:true});function wait(delay){return new Promise(function(resolve){setTimeout(resolve,delay)})}function repeat(fn,times){return new Promise(function(resolve,reject){var count=0;var results=[];function recurse(){if(count<times){count++;fn().then(function(result){results.push(result);recurse()})}else{resolve(results)}}recurse()})}function whilst(condition,callback){return new Promise(function(resolve,reject){function recurse(){if(condition()){callback().then(function(){return recurse()})}else{resolve()}}recurse()})}function nextId(){return _id++}var _id=0},{}]},{},[3])(3)});